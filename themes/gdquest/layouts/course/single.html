{{ define "main" }}

<!-- Setting up variables -->
<!-- Storing the course options in variables -->
{{ if isset .Site.Data.courses .Params.course }}
  {{ $options := (index .Site.Data.courses .Params.course).options }}

  {{ if isset .Params "playlist" }}
    {{ $.Scratch.Set "playlist" .Params.playlist }}
  {{ else }}
    {{ $.Scratch.Set "playlist" (index $options "playlist") }}
  {{ end }}
  {{ $playlist := $.Scratch.Get "playlist" }}

  <!-- Set released videos -->
  {{ if and (isset .Params "videos_released") (ge .Params.videos_released 0) }}
    {{ $.Scratch.Set "videos_released" .Params.videos_released }}
  {{ else }}
    {{ $.Scratch.Set "videos_released" 10000 }}
  {{ end }}
  {{ $videos_released := $.Scratch.Get "videos_released" }}

<div row>
  <div column="8 +2">

    <header row>
      <h1 class="text--center">{{ .Title }} 
        <!--{{ if isset .Params "title_small" }} <small class="text--muted">{{ .Params.title_small }}</small> {{ end }}-->
      </h1>
      <!-- BANNER -->
      <div id="banner-image">
        <img src="{{ .Params.banner }}" alt="{{ .Title }}: Course page banner" />
      </div>


      <!-- INNER NAVIGATION -->
      <div class="card-box text--center">
        <ul class="card-content"> 
          <span class="text--muted">|</span>
          {{ range (index .Site.Data.courses .Params.course).course }}
            <a href="#{{ replace .title " " "-" }}">
            {{ .small }}
            </a>
          <span class="text--muted">|</span>
          {{ end }}
        </ul>
      </div>
    </header>


    <section id="course">
      <!-- Individual chapters -->
      {{ $.Scratch.Set "video_count" 0 }}

      {{ range (index .Site.Data.courses .Params.course).course }}
          <!-- Calculating videos released/total videos per chapter to tag the chapter as Upcoming/Wip/Done -->
          {{ $.Scratch.Set "chapter_video_done" 0 }}
          {{ $.Scratch.Set "chapter_video_total" 0 }}
          {{ $.Scratch.Set "chapter_duration" 0 }}

          {{ range .videos }}
            {{ if isset . "length" }}
            {{ $.Scratch.Add "chapter_duration" .length }}
            {{ end }}
            <!--{{ if isset . "url" }}
            {{ $.Scratch.Add "chapter_video_done" 1 }}
            {{ end }}
            {{ $.Scratch.Add "chapter_video_total" 1 }}-->
          {{ end }}

          <!-- Reset the chapter's video count for each individual chapter -->
          <!--{{ $.Scratch.Set "video_count_chapter" 0 }}

          {{ if eq ($.Scratch.Get "chapter_video_done") ($.Scratch.Get "chapter_video_total") }}
            {{ $.Scratch.Set "chapter_label" 0 }}
          {{ else if and (lt ($.Scratch.Get "chapter_video_done") ($.Scratch.Get "chapter_video_total")) (gt ($.Scratch.Get "chapter_video_done") 0) }}
            {{ $.Scratch.Set "chapter_label" 1 }}
          {{ else }}
            {{ $.Scratch.Set "chapter_label" 2 }}
          {{ end}}
          {{ $chapter_label := $.Scratch.Get "chapter_label" }}-->

          <!-- Chapter title card -->
          <div class="card-box text--center">
            <div class="card-content">
              <h2 id="{{ replace .title " " "-" }}">
                {{ .title }} 
                <small> 
                  {{ if and ( isset .Params "wip" ) ( eq .Params.wip "true" ) }}
                    {{ if eq $chapter_label 0 }} <i class="fa fa-check text--success"></i> {{ else if eq $chapter_label 1 }} <span class="label bg--primary">WIP</span> {{ else }} <span class="label bg--muted">TO DO</span> {{ end }}
                  {{ end }}
                </small>
              </h2>

              {{ $chapter_duration := ($.Scratch.Get "chapter_duration") }}
              {{ if gt $chapter_duration 0 }}
                <span class="text--muted">Duration: {{ div $chapter_duration 60 }} min {{ mod $chapter_duration 60 }} s </span>
              {{ end }}
              <p>{{ .description | markdownify }}</p>        
            </div>
            

          </div>

          <!-- Ranging over individual videos in a chapter -->
          
            <ul class="collection">
              {{ range .videos }}
                <!-- Add 1 to the listed video count -->
                {{ $.Scratch.Add "video_count" 1 }}
                {{ $.Scratch.Add "video_count_chapter" 1 }}
  
                <li class="collection-item">
                  <!-- Video title and link -->
                  {{ if and (le ($.Scratch.Get "video_count") $videos_released ) (and (isset . "url") (not (eq .url "") )) }}
                    <a href="{{ .url }}{{ $playlist }}">
                      <!--{{ $.Scratch.Get "video_count_chapter" }}. -->
                      {{ .title }}
                    </a>
                  {{ else }}{{ $.Scratch.Get "video_count_chapter" }}. {{ .title }} <span class="text--muted">Upcoming</span> {{ end }}
  
                  <!-- Extra course material attached to a video -->
                  {{ if le ($.Scratch.Get "video_count") $videos_released  }}
                    {{ if isset . "document" }} <a href="{{ .document }}"><i class="fa fa-book fa-lg"></i></a> {{ end }}
                    {{ if isset . "exercise" }} <a href="{{ .exercise }}"><i class="fa fa-file fa-lg"></i></a> {{ end }}
                  {{ end }}
  
                  <!-- Video length -->
                  {{ if isset . "length" }}
                    {{ if ne .length 0  }}
                      {{ $minutes := div .length 60 }}
                      {{ $seconds := mod .length 60 }}
                      
                      {{ $video_length := div .length 60 }}
                      {{ if ( gt ( mod .length 60 ) 30 ) }}
                        {{ $.Scratch.Set "video_length" 1 }}
                      {{ else }}
                        {{ $.Scratch.Set "video_length" 0 }}
                      {{ end }}
  
                      {{ $video_length := add $video_length ( $.Scratch.Get "video_length" ) }}
  
                      <span class="text--muted">({{ $video_length }} min)</span>
                    {{ end }}
                  {{ end }}
                </li>
              {{ end }}
            </ul>
      {{ end }}
    
      <aside>
        {{ if isset .Params "author" }}
        <p class="text--muted">
          Meet your mentor
        </p>
        {{ partial "modules/author" . }}
        {{ end }}
      </aside>

      {{ end }}
    </section>
  </div>
</div>
{{ end }}
